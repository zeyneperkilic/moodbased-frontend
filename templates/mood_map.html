<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mood-Based Song Map</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: white; color: black; }
    .filter-btn, .home-btn { margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    #moodChart { width: 90%; height: 600px; margin: auto; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    .close { position: absolute; top: 10px; right: 20px; font-size: 24px; color: red; cursor: pointer; }
  </style>
</head>
<body>

  <button class="home-btn" onclick="window.location.href='/'">HomePage</button>

  <div style="margin: 20px;">
    <button class="filter-btn" style="background:red;" onclick="window.location.href='/mood-map/red'">Red</button>
    <button class="filter-btn" style="background:black; color:white;" onclick="window.location.href='/mood-map/black'">Black</button>
    <button class="filter-btn" style="background:yellow;" onclick="window.location.href='/mood-map/yellow'">Yellow</button>
    <button class="filter-btn" style="background:green;" onclick="window.location.href='/mood-map/green'">Green</button>
  </div>

  <div id="moodChart"></div>

  <div id="songModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Spotify Player</h3>
      <iframe id="spotifyIframe" width="300" height="380" frameborder="0" allow="encrypted-media"></iframe>
    </div>
  </div>

  <script>
    const allSongs = {{ all_songs | tojson | safe }};
    let currentSongUri = "";

    function showSongModal(uri) {
      currentSongUri = uri;
      const trackId = uri.split(':').pop();
      document.getElementById('spotifyIframe').src = `https://open.spotify.com/embed/track/${trackId}`;
      document.getElementById('songModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('songModal').style.display = 'none';
    }

    function plotSongs() {
      const x = allSongs.map(s => s.PCA1);
      const y = allSongs.map(s => s.PCA2);
      const z = allSongs.map(s => s.PCA3);
      const labels = allSongs.map(s => s.uri);

      Plotly.newPlot('moodChart', [{
        x, y, z, text: labels,
        mode: 'markers',
        type: 'scatter3d',
        marker: { size: 6, color: "{{ mood_color }}" },
        hovertemplate: "<b>URI:</b> %{text}<extra></extra>"
      }], {
        margin: { l: 0, r: 0, b: 0, t: 30 }
      });

      document.getElementById('moodChart').on('plotly_click', function(data) {
        const index = data.points[0].pointNumber;
        showSongModal(allSongs[index].uri);
      });

      // Mobile fallback
      document.getElementById('moodChart').addEventListener('touchend', function(e) {
        const scene = document.getElementById('moodChart').querySelector('.plotly');
        const touch = e.changedTouches[0];
        const rect = scene.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        Plotly.d3.json('', () => { // dummy fetch to delay plot detection
          Plotly.Fx.hover('moodChart', [{ xval: x, yval: y }], 'scene');
        });

        setTimeout(() => {
          const hoverData = document.querySelector('.hovertext');
          if (hoverData) {
            const text = hoverData.innerText;
            const found = allSongs.find(s => s.uri.includes(text.trim()));
            if (found) showSongModal(found.uri);
          }
        }, 200);
      });
    }

    plotSongs();
  </script>

</body>
</html>
